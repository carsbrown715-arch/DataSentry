# DataSentry 数据清洗中台架构重设计（基于已有功能改造版）

> 说明：本文件不是从零设计，而是基于当前已实现能力做“保留/改造/增强”架构决策。  
> 范围：清洗、回滚、审核三条主链路，以及它们的中台化治理关系。

---

## 1. 已有功能体检与改造结论

## 1.1 清洗链路（在线 + 批处理）

### 已有能力（保留）
- 在线清洗主链路完整，具备检测、决策、脱敏、审计。
- 批处理主链路完整，具备作业调度、租约、checkpoint、DLQ。
- 预算与成本台账、L2/L3 降级观测能力已具备。

### 需要改造（必须）
1. **影子模式能力不足**：当前更像“采样日志”，缺少主/影双轨结果对比与策略评估闭环。  
2. **策略治理不足**：当前策略是可编辑对象，缺少“受控发布/冻结/回退”治理层。  
3. **批处理边界约束偏硬**：当前仅支持单主键、METADB 备份模式，导致适配面受限。

### 架构结论
- 清洗架构不重做，沿现有 pipeline 继续。
- 增加“策略实验层 + 发布治理层 + 结果对照层”三块。

## 1.2 回滚链路

### 已有能力（保留）
- 已有独立回滚任务模型与调度器。
- 已有回滚 checkpoint 与批量恢复机制。
- 已有备份加密与密钥校验。

### 需要改造（必须）
1. **回滚验证层偏弱**：恢复后缺少标准化验证与冲突分级处置。  
2. **恢复粒度与策略不足**：当前偏“全量恢复执行”，缺少按影响面分级恢复策略。  
3. **回滚结果运营化不足**：可执行但“可理解、可复盘、可追责”能力不够强。

### 架构结论
- 保留现有回滚执行器与调度。
- 增加“恢复验证层 + 冲突处置层 + 回滚证据层”。

## 1.3 审核链路

### 已有能力（保留）
- 审核任务创建、审批、批量审批已落地。
- 审批后写回已接入一致性校验与冲突状态。
- 前端已具备审核工作台与批量操作。

### 需要改造（必须）
1. **审核运营能力不足**：当前偏处理台，缺少 SLA、积压、优先级治理模型。  
2. **审核反馈闭环不足**：审批结果尚未形成系统化“策略优化输入”。  
3. **审核风险分层不足**：不同风险等级的路由和处置策略需要进一步结构化。

### 架构结论
- 保留现有人审主流程。
- 增加“审核运营层 + 反馈学习层 + 风险分级层”。

---

## 2. 重设计后的总体架构

保持现有技术主干，新增中台治理层次，形成“4 层架构”：

1. **策略层**：策略、规则、白名单、动作配置。  
2. **执行层**：在线执行、批处理执行、回滚执行、审核执行。  
3. **治理层**：发布治理、实验治理、成本治理、风险治理。  
4. **证据层**：审计证据、回滚证据、审核证据、复盘证据。

核心变化不是重写执行引擎，而是把已有能力上提到“中台治理范式”。

---

## 3. 清洗架构重设计

## 3.1 保留的执行骨架
- 保留现有节点化 pipeline（归一化→检测→决策→脱敏→审计）。
- 保留在线与批处理双通道。
- 保留预算/成本/告警基础能力。

## 3.2 新增的治理骨架

### A. 策略发布治理
- 策略从“配置对象”升级为“发布资产”。
- 运行实例继续使用快照，但快照来源变成“已发布版本”。

### B. 影子实验治理
- 主轨执行真实动作。
- 影子轨只做判定与脱敏模拟，不做落库动作。
- 对照输出：命中差异、误杀风险、成本差异、审核压力变化。

### C. 策略回退治理
- 新策略效果不达标时，支持快速回退到上一发布版本。
- 回退行为进入统一证据层，便于审计。

## 3.3 架构收益
- 策略迭代从“主观试错”变成“实验驱动”。
- 在不破坏线上稳定性的前提下推进优化。

---

## 4. 回滚架构重设计

## 4.1 保留的执行骨架
- 保留“备份记录 + 回滚任务 + 调度执行 + checkpoint”。

## 4.2 新增的三层能力

### A. 恢复验证层
- 回滚后必须走一致性验证，不能仅以 SQL 执行成功作为成功标准。
- 验证结果分层：完全成功 / 部分成功 / 冲突未恢复。

### B. 冲突处置层
- 冲突不再统一按失败处理。
- 增加分级策略：自动重试、转审核、人工介入。

### C. 回滚证据层
- 每次回滚沉淀标准证据：影响范围、恢复成功率、冲突清单、未恢复原因。
- 证据用于合规审计和运维复盘。

## 4.3 架构收益
- 回滚从“能跑”升级到“可证明恢复”。
- 误判损失可控，运营团队可快速处置。

---

## 5. 审核架构重设计

## 5.1 保留的执行骨架
- 保留审核任务、审批动作、批量审批、审批后写回执行。

## 5.2 新增的三层能力

### A. 审核运营层
- 增加审核队列治理模型：积压、超时、优先级、吞吐。
- 让审核从“人工点按钮”变成“可管理工单流”。

### B. 风险分级层
- 按风险等级区分审核策略（高风险强审、中风险抽审、低风险免审）。
- 审核资源优先投向高风险与高争议样本。

### C. 反馈学习层
- 审核结论结构化沉淀。
- 作为规则阈值调优、白名单优化、影子实验选样输入。

## 5.3 架构收益
- 审核不再是系统瓶颈，而成为策略学习引擎。

---

## 6. 需要同步改造的横向能力

## 6.1 策略治理
- 补齐发布、回退、实验评估三个动作。

## 6.2 合规治理
- 将清洗、回滚、审核证据统一归档。
- 支持“谁在什么策略下对哪些数据做了什么”的追溯。

## 6.3 运营治理
- 统一质量、成本、审核负载、回滚成功率四类指标看板。

---

## 7. 架构重设计后的实施顺序

1. **先改治理层，不动核心执行路径**：先加发布/实验/证据框架。  
2. **再改回滚验证与冲突层**：提升恢复可信度。  
3. **再改审核运营与反馈层**：把审核变成学习入口。  
4. **最后统一指标与复盘机制**：形成中台闭环。

---

## 8. 结论

当前项目已有功能整体“可用且成体系”，不应推倒重来。

真正需要重写的不是执行引擎，而是：
- 清洗的策略治理方式；
- 回滚的验证与证据方式；
- 审核的运营与学习方式。

完成这些改造后，DataSentry 才能从“清洗功能集合”升级为“AI/合规导向的数据清洗中台”。

