# DataSentry 改造蓝图：AI/合规导向的数据清洗中台

> 文档目标：把当前 DataSentry 的数据清理能力，升级为“可持续运营、可审计、可回滚、可规模化”的企业级中台能力。  
> 适用范围：实时清洗、批处理治理、回滚恢复、人审协同、合规审计。  
> 对齐对象：`README.md`、`docs/DATA_CLEANING_ARCHITECTURE.md`、`docs/CLEANING_API_P2.md`。

---

## 1. 战略定位（Why / What）

### 1.1 产品定位

DataSentry 在 AI 时代的清晰定位应为：

**“AI/合规导向的数据清洗中台（Data Cleaning Control Tower）”**。

核心定义：
- 不是单点规则引擎。
- 不是只做离线质量评分的报表系统。
- 而是覆盖 **检测 → 决策 → 执行 → 回滚 → 审计** 的治理闭环中台。

### 1.2 业务价值主张

1. **合规降险**：降低 PII 泄露、违规内容落库、审计缺失等风险。  
2. **运营提效**：把清洗从“人工脚本”升级为“策略化作业 + 自动化运行”。  
3. **成本可控**：通过预算、模型路由、分层检测降低云模型调用成本。  
4. **可恢复**：写回动作全部可追溯、可回滚，避免误杀导致业务不可逆损失。

### 1.3 非目标（避免路线偏航）

- 不做“大而全”的通用数据治理平台替代品。
- 不与 BI、血缘图谱、主数据管理做重叠建设。
- 不在短期内追求“支持所有数据源/所有行业规则”。

---

## 2. 现状基线（As-Is）

基于仓库现有文档，当前已经具备中台化的关键雏形：

### 2.1 已有能力（可直接复用）

- 实时检测/脱敏 API：`POST /{agentId}/check`、`POST /{agentId}/sanitize`。
- 批处理任务体系：Job、JobRun、Pause/Resume/Cancel、预算/台账。
- 回滚链路：回滚任务创建与状态查询、备份策略模型。
- 人审链路：Review Policy（`ALWAYS/ON_RISK/NEVER`）与工作台入口。
- 合规基础：API Key、审计导向设计、最小权限、日志脱敏原则。

### 2.2 关键短板（To-Be 改造重点）

1. **中台产品化不足**：能力存在，但“策略运营 + 版本治理 + 组织协作”不够完整。  
2. **AI 能力闭环不足**：人审结果到策略优化的自动学习链路未完整沉淀。  
3. **合规证据链不足**：对外审计可直接导出的“策略-执行-证据”打包能力待增强。  
4. **场景模板化不足**：行业预置策略、误杀调优工具、灰度发布机制需加强。

---

## 3. 目标蓝图（To-Be）：五大闭环

目标是形成“实时 + 批处理 + 回滚 + 人审 + 合规”五环联动。

| 闭环 | 目标 | 核心动作 | 成功标准 |
|---|---|---|---|
| 实时闭环 | 在线风险拦截与脱敏 | 检测、策略决策、返回结果、审计事件 | P95 低延迟、低误杀 |
| 批处理闭环 | 存量数据持续治理 | 扫描、分批执行、断点续跑、失败重试 | 高吞吐、稳定可恢复 |
| 回滚闭环 | 降低误判代价 | 写前备份、差异恢复、回滚审计 | 回滚成功率高、可证明 |
| 人审闭环 | 高风险场景保守决策 | 任务分发、审批、复核、追责 | 审批 SLA 可控 |
| 合规闭环 | 满足审计与监管要求 | 权限分离、证据留存、TTL/Purge | 审计可通过、证据可导出 |

---

## 4. 中台架构设计（Control Tower）

建议从“控制面 + 执行面 + 治理面”三平面治理：

### 4.1 控制面（Control Plane）

职责：定义“怎么洗”。

核心能力：
- 策略中心（Policy/Rule/Allowlist/Action）
- 版本中心（Draft/Published/Rollback）
- 场景模板中心（客服、工单、营销文案、用户资料等）
- 发布编排（灰度/影子/全量）

关键改造点：
- 引入“策略发布单”概念：每次发布必须有变更说明、风险等级、回滚预案。
- 策略版本冻结到 JobRun，运行期不可变。

### 4.2 执行面（Execution Plane）

职责：把策略稳定执行到数据。

核心能力：
- 实时执行通道（API 低延迟）
- 批处理执行器（分片、限流、断点续跑、DLQ）
- 写回执行器（类型校验、幂等、冲突检测）
- 回滚执行器（按 run_id / record_id 精确恢复）

关键改造点：
- 执行前统一 Pre-flight：权限、备份状态、策略版本、预算检查。
- 执行后统一 Post-flight：指标上报、审计事件、证据归档。

### 4.3 治理面（Governance Plane）

职责：确保“可监管、可解释、可问责”。

核心能力：
- 审计中心（全链路事件）
- 合规中心（数据分级、保留期、被遗忘权）
- 人审工作台（审批流、复核、SLA）
- 运营看板（质量、成本、误杀、人工负载）

关键改造点：
- 建立“证据包（Evidence Bundle）”导出：策略快照 + 命中证据 + 动作记录 + 回滚记录。

---

## 5. AI 能力升级（从“规则+模型”到“可学习系统”）

### 5.1 检测分层与模型路由

建议固化三级检测策略：
- **L1 规则层**：正则、词典、黑白名单，低成本高吞吐。
- **L2 轻模型层**：ONNX/本地模型，覆盖语义近似场景。
- **L3 大模型层**：复杂上下文、对抗样本、跨句推理。

路由原则：
- 能在 L1/L2 判定的，不升级到 L3。
- 预算紧张时自动降级（L3 → L2）。
- 高风险场景允许“强制 L3 + 人审”。

### 5.2 人审反馈反哺策略

把人审决策沉淀为训练与策略资产：
- 审批结果自动生成误杀/漏杀样本集。
- 样本集用于规则推荐与阈值校准。
- 对高频争议规则自动触发“策略复盘任务”。

### 5.3 AI Copilot（策略运营助手）

新增中台助手能力（可分阶段实现）：
- 输入场景描述，自动生成策略初稿（规则 + 阈值 + 动作建议）。
- 基于历史数据给出“预计命中率/误杀率/成本”。
- 对策略变更生成风险提示与灰度建议。

---

## 6. 五大闭环的落地设计

### 6.1 实时闭环

标准流程：
1. 请求接入（鉴权、限流、追踪 ID）。
2. 内容解析（字段级、JSONPath、上下文元数据）。
3. 级联检测（L1→L2→L3）。
4. 决策执行（返回检测、返回脱敏、提交人审）。
5. 审计上报（不落明文、可追踪）。

SLO 建议：
- `check` P95 < 300ms（纯规则场景）
- `sanitize` P95 < 600ms（含轻模型场景）
- 可用性 ≥ 99.9%

### 6.2 批处理闭环

标准流程：
1. 创建 Job（绑定数据源、字段、策略版本）。
2. 启动 Run（领取租约、生成 checkpoint）。
3. 分批扫描（Keyset Pagination + 并发分片）。
4. 执行动作（检测/写回/软删/硬删/人审分流）。
5. 失败治理（重试、DLQ、告警）。

SLO 建议：
- 失败可恢复率 ≥ 99%
- 断点续跑成功率 ≥ 99.5%

### 6.3 回滚闭环

标准流程：
1. 写前强制备份（字段级或行级）。
2. 记录变更指纹（before/after hash）。
3. 触发回滚（按 run/record/时间窗）。
4. 执行恢复并二次校验。
5. 输出回滚报告（成功/失败/冲突）。

硬约束：
- 未备份不得写回。
- 高风险动作（硬删）必须配置回滚窗口。

### 6.4 人审闭环

标准流程：
1. 命中“需人审”规则自动建单。
2. 按风险等级与租户策略分配审核队列。
3. 审核动作（通过/拒绝/改判/转交）。
4. 回写执行结果并更新策略样本库。

运营指标：
- 审核 SLA 达成率
- 人审通过率/驳回率
- 高频争议规则 TOP N

### 6.5 合规闭环

必须形成“制度 + 技术 + 证据”三位一体：
- 制度：数据分级、最小权限、双人审批（高风险动作）。
- 技术：脱敏存储、密钥托管、字段级访问控制、全链路留痕。
- 证据：可导出的审计报表与证据包。

---

## 7. 合规与安全治理框架

### 7.1 权限模型（建议）

至少拆分以下权限域：
- `policy:publish`
- `job:run`
- `writeback:execute`
- `delete:hard`
- `rollback:execute`
- `audit:export`

高风险权限建议默认关闭，按租户和环境显式开启。

### 7.2 数据安全控制

- 审计日志默认不存明文原始内容。
- 备份数据加密存储，主密钥由环境变量或 KMS 提供。
- 外部模型调用可配置“脱敏后出站”与“禁出站字段”。

### 7.3 生命周期治理

- 备份与审计记录统一 TTL 策略。
- 支持 Purge 作业满足“被遗忘权/数据最小保留”。
- 关键审计记录支持不可篡改留存（WORM 或签名哈希链）。

---

## 8. 产品化能力补齐清单（按优先级）

### P0（必须）

1. 策略版本发布流（草稿/发布/回滚）。
2. 影子模式全链路（实时与批处理均支持）。
3. 回滚报告标准化（可下载、可审计）。
4. 人审工作台补齐 SLA 看板。

### P1（高优先）

1. 策略模板库（行业 + 场景）。
2. AI Copilot 生成策略初稿与风险提示。
3. 证据包导出（审计/API）。
4. 多租户隔离增强（策略、作业、审计分域）。

### P2（增强）

1. 主动学习闭环（人审样本自动反哺）。
2. 自动阈值校准与 A/B 策略对比。
3. 模型效果回归评测流水线。

---

## 9. 指标体系（中台运营 KPI）

### 9.1 质量指标

- Precision（准确率）
- Recall（召回率）
- False Positive Rate（误杀率）
- False Negative Rate（漏杀率）

### 9.2 稳定性指标

- Run 成功率
- 回滚成功率
- DLQ 积压量与平均恢复时长
- 实时 API 可用性与延迟分位

### 9.3 成本指标

- 每万条处理成本
- L3（大模型）调用占比
- 单策略单位收益（风险降低 / 成本）

### 9.4 合规指标

- 高风险动作双人审批覆盖率
- 审计事件完整率
- 证据包生成成功率

---

## 10. 分阶段实施路线图（建议）

### Phase A（0-30 天）：中台最小可运营化

目标：把“有能力”变成“可运营”。

交付：
- 策略发布流（含版本冻结）
- 影子模式可视化
- 回滚报告模板
- 人审 SLA 基础看板

验收：
- 至少 2 个真实业务场景跑通端到端。

### Phase B（31-90 天）：AI/合规双增强

目标：提升效果与可审计性。

交付：
- AI Copilot 策略建议（Beta）
- 证据包导出 API
- 高频误杀规则复盘机制
- 外部模型出站合规控制策略

验收：
- 误杀率较基线下降 20%+。

### Phase C（91-180 天）：规模化与生态化

目标：支撑多团队、多租户、持续优化。

交付：
- 主动学习与阈值自动校准
- 多租户隔离增强
- 场景模板市场（可复用策略包）
- 模型回归评测流水线

验收：
- 3 个以上租户稳定运行，关键 SLO 达标。

---

## 11. 与现有工程的落地映射

### 11.1 后端（`datasentry-management`）

- 复用已有 Cleaning API 与 JobRun 状态机。
- 增强策略发布流、证据包导出、审计统一事件模型。
- 将人审反馈接入策略优化服务。

### 11.2 前端（`datasentry-frontend`）

- `CleaningJobManager.vue`：补齐灰度发布、回滚报告入口。
- `CleaningOpsDashboard.vue`：补齐质量/成本/合规三维指标。
- `CleaningReviewWorkbench.vue`：补齐 SLA 与争议规则视图。
- `CleaningRealtime.vue`：补齐影子模式与策略对比视图。

---

## 12. 风险与应对

| 风险 | 表现 | 应对策略 |
|---|---|---|
| 误杀影响业务 | 正常内容被清理/删除 | 默认保守动作 + 人审兜底 + 可回滚 |
| 成本失控 | 大模型调用激增 | 三级路由 + 预算阈值 + 自动降级 |
| 审计不足 | 事后无法追责 | 证据包 + 事件标准化 + 定期审计演练 |
| 组织协同失败 | 规则团队与业务团队脱节 | 策略发布单 + 周度复盘 + 责任域明确 |

---

## 13. 结论

DataSentry 已具备“闭环雏形”，下一步关键不是继续堆能力点，而是将其产品化为“中台运营系统”：

- 对内：形成策略治理、执行治理、合规治理的统一控制塔。  
- 对外：提供可解释、可审计、可恢复的数据清洗能力。  
- 对未来：通过 AI 反馈学习，让策略体系持续进化，而不是一次性规则工程。

当上述路线落地后，DataSentry 的竞争形态将从“功能模块”升级为“企业级 AI 清洗基础设施”。

