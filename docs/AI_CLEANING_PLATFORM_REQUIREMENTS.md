# DataSentry AI/合规导向数据清洗中台需求文档（PRD）

> 版本：v1.0  
> 状态：可评审/可排期  
> 关联文档：`docs/AI_COMPLIANCE_CLEANING_PLATFORM.md`、`docs/DATA_CLEANING_ARCHITECTURE.md`、`docs/CLEANING_API_P2.md`

---

## 1. 背景与目标

### 1.1 背景

当前 DataSentry 已具备实时清洗、批处理、回滚、人审、审计基础能力，但仍偏“能力集合”。

企业在 AI 时代的数据治理诉求已经从“能检测”升级为“可闭环治理”：
- 在线请求实时拦截/脱敏；
- 存量数据持续治理；
- 高风险动作可审可回滚；
- 合规证据可导出、可审计。

### 1.2 目标

建设“AI/合规导向的数据清洗中台”，形成五大闭环：
- 实时闭环
- 批处理闭环
- 回滚闭环
- 人审闭环
- 合规闭环

### 1.3 非目标

- 不建设大而全的数据治理套件（血缘、主数据、BI 报表不在本期）。
- 不覆盖所有行业模板与所有数据源连接器。

---

## 2. 用户与场景

### 2.1 目标用户

1. **平台管理员**：管理策略、权限、审计、发布。  
2. **数据治理工程师**：编排作业、观察指标、处理异常。  
3. **业务审核员**：处理高风险人审任务。  
4. **合规/内审人员**：导出证据、核验流程合规性。

### 2.2 核心场景

1. **在线文本入库前清洗**：客服、工单、用户资料等写库前脱敏。  
2. **存量数据库治理**：历史数据扫描并按策略处理。  
3. **策略变更灰度验证**：影子模式评估新策略效果。  
4. **误判后快速恢复**：按 JobRun 或记录粒度回滚。  
5. **审计取证**：导出策略快照、执行记录、回滚记录。

---

## 3. 功能需求

## 3.1 策略中心

### FR-01 策略生命周期
- 支持草稿、发布、下线、回滚四状态。
- 每次发布生成版本号，支持版本说明与变更摘要。
- JobRun 启动后绑定策略快照，运行中不可变。

### FR-02 规则体系
- 支持规则、词典、模型阈值、白名单。
- 支持按场景绑定动作模式（`DETECT_ONLY` / `SANITIZE_RETURN` / `SANITIZE_WRITEBACK` / `REVIEW_THEN_WRITEBACK` / `DELETE`）。

### FR-03 策略模板
- 提供行业/场景模板库（如客服文本、用户资料、营销文案）。
- 支持模板一键复制为租户私有策略。

## 3.2 实时闭环

### FR-10 实时接口
- 提供 `POST /{agentId}/check` 与 `POST /{agentId}/sanitize`。
- 支持 `traceId` 贯穿链路。

### FR-11 分层检测与路由
- 支持 L1（规则）、L2（轻模型）、L3（大模型）分层检测。
- 支持预算阈值触发自动降级（L3→L2）。

### FR-12 实时审计
- 对实时请求记录审计事件。
- 默认不落原文明文。

## 3.3 批处理闭环

### FR-20 作业管理
- 支持创建任务、启动 Run、暂停、恢复、取消。
- 支持断点续跑、租约领取、心跳续租。

### FR-21 执行动作
- 支持检测、脱敏写回、软删、硬删（受控）。
- 支持写回字段类型校验与长度保护。

### FR-22 异常治理
- 支持失败重试与 DLQ。
- 支持告警（运行失败、降级、预算超限）。

## 3.4 回滚闭环

### FR-30 备份策略
- 写回/删除前必须完成备份（字段级或行级）。
- 支持 `METADB` 与 `BUSINESS_DB` 双模备份。

### FR-31 回滚能力
- 支持按 `runId`、`recordId`、时间窗触发回滚。
- 生成回滚报告（成功/失败/冲突详情）。

## 3.5 人审闭环

### FR-40 人审任务流
- 支持 `ALWAYS/ON_RISK/NEVER` 人审策略。
- 支持审核通过、驳回、改判、转交。

### FR-41 SLA 与反馈
- 显示审核队列、超时任务、审批效率。
- 审核结果可反哺样本库，用于策略优化。

## 3.6 合规闭环

### FR-50 权限分离
- 至少拆分 `policy:publish`、`writeback:execute`、`delete:hard`、`rollback:execute`、`audit:export`。

### FR-51 证据包导出
- 支持导出某次治理任务的证据包：策略快照、命中与动作、审批记录、回滚记录。

### FR-52 生命周期
- 支持备份与审计记录 TTL/Purge。
- 支持合规场景保留期配置。

---

## 4. 非功能需求

### NFR-01 性能与可用性
- 实时 `check`：P95 < 300ms（规则场景）。
- 实时 `sanitize`：P95 < 600ms（规则+轻模型场景）。
- 核心 API 可用性：≥99.9%。

### NFR-02 稳定性
- 批处理失败可恢复率：≥99%。
- 回滚成功率：≥99.5%。

### NFR-03 安全与合规
- 默认不记录明文敏感信息。
- 高风险动作需强权限控制。
- 审计事件可追踪、可导出。

### NFR-04 可观测性
- 暴露运行指标、成本指标、合规指标。
- 支持 trace 维度全链路检索。

---

## 5. 关键业务规则

1. 未备份不得写回或删除。  
2. 硬删默认禁用，需显式授权并建议双人审批。  
3. 运行中的 JobRun 不允许策略热修改。  
4. 审计日志中敏感字段必须脱敏。  
5. 外部模型调用需遵循出站策略（可配置脱敏后出站）。

---

## 6. 验收标准（UAT）

### 6.1 功能验收
- 能创建策略并完成发布-灰度-回滚流程。
- 实时接口可在不同策略下返回检测与脱敏结果。
- 批处理任务可稳定跑完并支持断点续跑。
- 回滚可按 run 粒度成功恢复并输出报告。
- 人审工作台能闭环处理高风险任务。

### 6.2 合规验收
- 导出证据包可覆盖一次完整治理链路。
- 权限分离可阻断未授权高风险操作。
- TTL/Purge 配置生效且有审计记录。

### 6.3 运营验收
- 看板可展示质量、成本、稳定性、合规四类指标。
- 可定位 TOP 误杀规则并支持复盘。

---

## 7. 里程碑

### M1（0-30天）
- 策略发布流
- 影子模式可视化
- 回滚报告标准化
- 人审 SLA 基础看板

### M2（31-90天）
- 证据包导出
- AI Copilot（策略建议 Beta）
- 外部模型出站合规策略

### M3（91-180天）
- 主动学习闭环
- 自动阈值校准
- 多租户治理增强

---

## 8. 风险与依赖

### 8.1 风险
- 误杀导致业务异常。
- 模型调用成本不可控。
- 审核资源不足造成任务积压。

### 8.2 依赖
- 数据源连接与权限配置。
- 模型服务可用性与成本策略。
- 合规团队参与评审与验收。

